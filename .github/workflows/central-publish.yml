name: Publish to the Ballerina central

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Select environment
        required: true
        options:
          - CENTRAL
      release_version:
        type: string
        description: Enter the release version
        required: true
      org:
        type: string
        description: Enter the organization name
        required: true

jobs:
  publish-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: ballerina-platform/setup-ballerina@v1
        name: Install Ballerina
        with:
          version: 2201.7.0
      - name: Pull EDI Tool
        run: bal tool pull edi
      - name: Generate Ballerina Source code
        run: |
          current_path="$PWD"
          versions=("d03a")
          for version in "${versions[@]}"; do
            cd "$current_path/$version"
            packages=$(ls -d *)
            for package in $packages; do
              cd "$current_path/$version/$package"
              echo "Running libgen on : $package"
              bal edi libgen -O ${{ inputs.org }} -n "edifact.$version.$package" -s "schema" -o "$package/target"
              tree $package/target 
            done
          done
      - name: install 2201.6.0
        run: sudo bal dist pull 2201.6.0
      - name: pack
        run: |
          current_path="$PWD"
          versions=("d03a")
          for version in "${versions[@]}"; do
            cd "$current_path/$version"
            packages=$(ls -d *)
            for package in $packages; do
              ls
              pwd
              cd "$current_path/$version/$package/target/edifact.$version.$package"
              echo "Running bal pack on : $package"
              ls
              pwd
              sed -i "s/version = \"[^\"]*\"/version = \"${{ inputs.release_version }}\"/" "Ballerina.toml"
              bal pack
            done
          done
        working-directory:
      - name: push
        env:
          BALLERINA_CENTRAL_ACCESS_TOKEN: ${{ secrets.BALLERINA_CENTRAL_ACCESS_TOKEN }}
        run: |
          current_path="$PWD"
          versions=("d03a")
          for version in "${versions[@]}"; do
            cd "$current_path/$version"
            packages=$(ls -d *)
            for package in $packages; do
              cd "$current_path/$version/$package/target/edifact.$version.$package"
              echo "Running bal push on : $package"
              #bal push
            done
          done
